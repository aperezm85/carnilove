---
import FAQ from "@/components/FAQ.astro";
import Feed from "@/components/Feed.astro";
import FindYourPath from "@/components/FindYourPath.astro";

import Hero from "@/components/Hero/Hero.astro";
import Ingredients from "@/components/Ingredients.astro";
import Instincts from "@/components/Instincts.astro";
import ShopProduct from "@/components/ShopProduct.astro";
import Layout from "@/layouts/Layout.astro";
---

<Layout>
  <Hero />
  <ShopProduct />
  <Feed />
  <Instincts />
  <Ingredients />
  <FindYourPath />
  <FAQ />

  <section
    id="savannah"
    class="bg-[url(/savannah.jpg)] bg-cover bg-center bg-no-repeat w-full h-[569px] fixed z-10"
  >
  </section>
</Layout>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";
  import { SplitText } from "gsap/SplitText";

  gsap.registerPlugin(ScrollTrigger, SplitText);

  const sections = document.querySelectorAll(".pin-section");

  sections.forEach((section, index) => {
    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: section,
        start: "top top",
        end: "bottom top",
        pin: true,
        pinSpacing: false,
        scrub: 1,
        // markers: true,
        snap: 1,
      },
    });
    // Example animation inside timeline
  });

  // prefer transform-based motion for smoother GPU-accelerated animation
  const savannah = document.getElementById("savannah");
  const shopSection = document.getElementById("shop-by-product");
  const feed = document.getElementById("feed-their-nature");
  const productCards = document.querySelectorAll(".product-card");
  const feedTitle = document.getElementById("feed-their-nature-title");
  const videoFeedPlaceholder = document.getElementById(
    "video-feed-placeholder"
  );

  const FAQ = document.getElementById("FAQ");

  if (savannah && shopSection && feed) {
    // Timeline for bottom transitions
    const tl = gsap.timeline();

    gsap.set(savannah, { top: "100%" });

    // First scroll trigger: move into view at -200px
    tl.to(savannah, {
      top: "-=300px",
      duration: 1,
      ease: "power2.out",
      scrollTrigger: {
        trigger: "#shop-by-product",
        start: "top bottom",
        end: "bottom top", // short range to trigger once
        scrub: true,
        pin: true,
      },
    });

    // Second scroll trigger: adjust to -100px without resetting
    tl.to(savannah, {
      top: "-=200px",
      duration: 1,
      ease: "power2.out",
      scrollTrigger: {
        trigger: feed,
        start: "top top",
        end: "bottom top",
        scrub: false,
        pin: true,
      },
    });

    tl.to(savannah, {
      top: "-=200px",
      duration: 1,
      ease: "power2.out",
      scrollTrigger: {
        trigger: "#ingredients",
        start: "top top",
        end: "bottom top",
        scrub: false,
        pin: true,
      },
    });
  }

  if (productCards.length > 0) {
    gsap.to(productCards, {
      y: -200,
      opacity: 0,
      duration: 0.6,
      ease: "power2.out",
      stagger: 0.06,
      scrollTrigger: {
        trigger: feed,
        start: "top bottom",
        end: "top center",
        toggleActions: "play none reverse reverse",
      },
    });
  }

  if (feedTitle) {
    // Run SplitText only after fonts are loaded to ensure correct measurements.
    const initSplitText = () => {
      // If SplitText was already applied, kill previous instance (defensive)
      try {
        // Create SplitText on the actual element node rather than a string selector
        const mySplitText = new SplitText(feedTitle, { type: "chars" });
        const chars = mySplitText.chars;

        gsap.from(chars, {
          yPercent: 130,
          stagger: 0.02,
          ease: "back.out",
          duration: 1,
          scrollTrigger: {
            trigger: feedTitle,
            start: "top 50%",
            toggleActions: "play reverse restart reset",
          },
        });
      } catch (err) {
        // If SplitText fails for any reason, log and bail gracefully
        console.warn("SplitText init failed:", err);
      }
    };

    if (document.fonts && document.fonts.ready) {
      // Wait for all fonts declared in CSS to be loaded
      document.fonts.ready.then(initSplitText).catch(initSplitText);
    } else {
      // Fallback: wait for window load
      window.addEventListener("load", initSplitText, { once: true });
    }
  }

  if (videoFeedPlaceholder) {
    gsap.from(videoFeedPlaceholder, {
      yPercent: 130,
      stagger: 0.02,
      ease: "back.out",
      duration: 1,
      scrollTrigger: {
        trigger: feedTitle,
        start: "top 50%",
        end: "bottom 40%",
        toggleActions: "play reset restart reset",
      },
    });
  }
</script>
